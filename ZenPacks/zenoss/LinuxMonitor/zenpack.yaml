name: ZenPacks.zenoss.LinuxMonitor

classes:
    DEFAULTS:
        base: [zenpacklib.Component]

    PhysicalVolume:
        label: Physical Volume
        impacts:
            - volumeGroup
        properties:
            pvsize:
                label: Size
                type: int
                renderer: Zenoss.render.bytesString
                datapoint: volume_size
                order: 4.1
            free:
                label: Free
                type: int
                renderer: Zenoss.render.bytesString
                datapoint: volume_free
                order: 4.2
            utilization:
                label: '% Util'
                order: 4.3
                api_only: true
                api_backendtype: method
            format:
                label: Format
                order: 4.0
            attributes:
                label: Attributes
                grid_display: False
                type: lines
            uuid:
                grid_display: False

    VolumeGroup:
        label: Volume Group
        impacts:
            - logicalVolumes
            - snapshotVolumes
        impacted_by:
            - physicalVolumes
        properties:
            vgsize:
                label: Size
                type: int
                datapoint: group_size
                renderer: Zenoss.render.bytesString
                order: 4.1
            freesize:
                label: Free
                type: int
                datapoint: group_free
                renderer: Zenoss.render.bytesString
                order: 4.2
            utilization:
                label: '% Util'
                order: 4.3
                api_only: true
                api_backendtype: method
            snapshot_volumes:
                label: Snapshot Volumes
                api_backendtype: method
                api_only: true
            attributes:
                label: Attributes
                grid_display: False
                type: lines
            uuid:
                grid_display: False

    LogicalVolume:
        label: Logical Volume
        impacts:
            - snapshotVolumes
            - openstack_core_components
        impacted_by:
            - volumeGroup
        properties:
            attributes:
                label: Attributes
                grid_display: False
                type: lines
            lvsize:
                label: Size
                type: int
                renderer: Zenoss.render.bytesString
            active:
                label: Active
                renderer: Zenoss.render.checkbox
            vgname:
                grid_display: False
                details_display: False
            uuid:
                grid_display: False
                details_display: False
            openstack_core_components:
                type: entity
                label: Cinder Integration
                grid_display: false
                api_only: true
                api_backendtype: method

    SnapshotVolume:
        label: Snapshot Volume
        impacted_by:
            - volumeGroup
            - logicalVolume
        impacts:
            - openstack_core_components
        properties:
            attributes:
                label: Attributes
                grid_display: False
                type: lines
            lvsize:
                label: Size
                type: int
                renderer: Zenoss.render.bytesString
            active:
                type: boolean
                renderer: Zenoss.render.checkbox
                label: Active
            origin:
                grid_display: False
            vgname:
                grid_display: False
                details_display: False
            uuid:
                grid_display: False
                details_display: False
            openstack_core_components:
                type: entity
                label: Cinder Integration
                grid_display: false
                api_only: true
                api_backendtype: method

class_relationships:
    - Products.ZenModel.Device.Device 1:MC VolumeGroup
    - Products.ZenModel.Device.Device 1:MC PhysicalVolume
    - VolumeGroup 1:M PhysicalVolume
    - VolumeGroup 1:MC LogicalVolume
    - LogicalVolume 1:MC SnapshotVolume

device_classes: !ZenPackSpec
    /Server/SSH/Linux:
        zProperties:
            zCollectorPlugins:
                - zenoss.cmd.df
                - zenoss.cmd.uname
                - zenoss.cmd.linux.cpuinfo
                - zenoss.cmd.linux.ifconfig
                - zenoss.cmd.linux.lvm
                - zenoss.cmd.linux.memory
                - zenoss.cmd.linux.netstat_an
                - zenoss.cmd.linux.netstat_rn
                - zenoss.cmd.linux.process
                - zenoss.cmd.linux.rpm
                - zenoss.cmd.linux.sudo_dmidecode
                - zenoss.cmd.linux.os_release
            zSshConcurrentSessions: 5

        templates:
            PhysicalVolume:
                description: Physical Volume Monitoring
                datasources:
                    volume:
                        type: COMMAND
                        commandTemplate: '/usr/bin/sudo /usr/sbin/pvs --noheadings --units b --nosuffix -o pv_name,pv_size,pv_free'
                        usessh: true
                        parser: ZenPacks.zenoss.LinuxMonitor.parsers.linux.utilization
                        datapoints:
                            size:
                                rrdmin: 0
                            free:
                                rrdmin: 0
                    status:
                        type: COMMAND
                        commandTemplate: '/usr/bin/sudo pvs -o pv_name,pv_missing'
                        usessh: true
                        parser: ZenPacks.zenoss.LinuxMonitor.parsers.linux.pvsstatus
                        datapoints:
                            status:
                                rrdmin: 0
                    diskstats:
                        type: COMMAND
                        commandTemplate: '/bin/cat /proc/diskstats'
                        usessh: true
                        parser: ZenPacks.zenoss.LinuxMonitor.parsers.linux.diskstats
                        datapoints:
                            readsCompleted:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: The number of read requests that were issued to the device per second.
                            readsMerged:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: The number of read requests merged per second that were queued to the device.
                            sectorsRead:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: The number of sectors read from the device per second.
                            msReading:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: Milliseconds spent by all reads in concrete moment of time.
                            writesCompleted:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: The number of write requests that were issued to the device per second.
                            writesMerged:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: The number of write requests merged per second that were queued to the device.
                            sectorsWritten:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: The number of sectors written to the device per second.
                            msWriting:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: Milliseconds spent by all writes in concrete moment of time.
                            ioInProgress:
                                rrdtype: GAUGE
                                rrdmin: 0
                                description: I/Os currently in progress.
                            msDoingIO:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: Milliseconds spent doing I/Os in concrete moment of time.
                            msDoingIOWeighted:
                                rrdtype: DERIVE
                                rrdmin: 0
                                description: This field is incremented at each I/O start, I/O completion, I/O merge, or read of these stats by the number of I/Os in progress times the number of milliseconds spent doing I/O since the last update of this field.
                graphs:
                    Utilization:
                        units: percent
                        miny: 0
                        maxy: 100
                        graphpoints:
                            size:
                                dpName: volume_size
                                lineType: DONTDRAW
                            free:
                                dpName: volume_free
                                lineType: AREA
                                rpn: "size,-,size,/,-100,*"
                    Operation Throughput:
                        units: operations/sec
                        miny: 0
                        graphpoints:
                            Reads:
                                dpName: diskstats_readsCompleted
                                lineType: LINE
                            Writes:
                                dpName: diskstats_writesCompleted
                                lineType: LINE
                    Merge Rate:
                        units: operations merged/sec
                        miny: 0
                        graphpoints:
                            Reads:
                                dpName: diskstats_readsMerged
                                lineType: LINE
                            Writes:
                                dpName: diskstats_writesMerged
                                lineType: LINE
                    Sector Throughput:
                        units: sectors/sec
                        miny: 0
                        graphpoints:
                            Read:
                                dpName: diskstats_sectorsRead
                                lineType: LINE
                            Written:
                                dpName: diskstats_sectorsWritten
                                lineType: LINE
                    IO Operations in Progress:
                        units: operations
                        miny: 0
                        graphpoints:
                            IO:
                                dpName: diskstats_ioInProgress
                                lineType: LINE
                    IO Utilization:
                        units: percent
                        miny: 0
                        maxy: 100
                        graphpoints:
                            Reading:
                                dpName: diskstats_msReading
                                lineType: LINE
                                rpn: "10,/"
                            Writing:
                                dpName: diskstats_msWriting
                                lineType: LINE
                                rpn: "10,/"
                            Doing IO:
                                dpName: diskstats_msDoingIO
                                lineType: LINE
                                rpn: "10,/"
                    Weighted IO Utilization:
                        units: weighted percent
                        miny: 0
                        graphpoints:
                            Weighted IO:
                                dpName: diskstats_msDoingIOWeighted
                                lineType: LINE
                                rpn: "10,/"
            VolumeGroup:
                description: Volume Group Monitoring
                datasources:
                    group:
                        type: COMMAND
                        commandTemplate: '/usr/bin/sudo /usr/sbin/vgs --noheadings --units b --nosuffix -o vg_name,vg_size,vg_free'
                        usessh: true
                        parser: ZenPacks.zenoss.LinuxMonitor.parsers.linux.utilization
                        datapoints:
                            size:
                                rrdmin: 0
                            free:
                                rrdmin: 0
                graphs:
                    Volume Group Utilization:
                        units: percent
                        miny: 0
                        maxy: 100
                        graphpoints:
                            size:
                                dpName: group_size
                                lineType: DONTDRAW
                            free:
                                dpName: group_free
                                lineType: AREA
                                rpn: "size,-,size,/,-100,*"
